<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
    </head>
    <body>
	<div id="changesAndEffects" tyle="border:1px solid blue;">
	</div>
	<small><small>Timezone is PT unless otherwise specified</small></small>
	<br>
	<button type="button" id="refresh">Refresh</button> 
        <script type="text/javascript" src="./d3/d3.min.js"></script>
        <script type="text/javascript" src="./moment/moment.min.js"></script>
        <script type="text/javascript" src="./moment/moment-timezone-with-data.min.js"></script>
        <script type="text/javascript" src="./abc.js"></script>
        <script type="text/javascript">
		var cae = new ChangesAndEffects({
			container_selector: "#changesAndEffects",
			height: 500,
			width: 1000,
			change_url_formatter: function(ticket_id){
				return "https://www.servicenow.com/" + ticket_id;
			},
			series_keys: ["A", "B", "C", "D"],
		});
		
		var dataset = [
			{ "from":1533081600, "severity": {"worst":"0", "details":{}}, "counts": {A: 0, B: 10, C: 15, D: 10}, "changes":["CHG1234", "CHG2345"] },
			{ "from":1533082500, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 0, B: 10, C: 15, D: 9}, "changes":[] },
			{ "from":1533083400, "severity": {"worst":"2", "details":{"1":["Comp1"], "2":["Comp2"]}}, "counts": {A: 1, B: 10, C: 15, D: 13}, "changes":[] },
			{ "from":1533084300, "severity": {"worst":"3", "details":{"1":["Comp1"], "2":["Comp2", "Comp8"], "3":["Comp15"]}}, "counts": {A: 2, B: 10, C: 15, D: 8}, "changes":[] },
			{ "from":1533085200, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 0, B: 10, C: 15, D: 8}, "changes":["CHG3456", "CHG4567", "CHG7890"] },
			{ "from":1533086100, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 4, B: 10, C: 15, D: 8}, "changes":["CHG1234"] },
			{ "from":1533087000, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 1, B: 10, C: 15, D: 8}, "changes":["CHG1234"] },
			{ "from":1533087900, "severity": {"worst":"0", "details":{}}, "counts": {A: 1, B: 10, C: 15, D: 8}, "changes":["CHG1234"] },
			{ "from":1533088800, "severity": {"worst":"0", "details":{}}, "counts": {A: 3, B: 15, C: 15, D: 8}, "changes":["CHG1234", "CHG2345"] },
			{ "from":1533089700, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 0, B: 12, C: 15, D: 8}, "changes":["CHG1234", "CHG2345"] },
			{ "from":1533090600, "severity": {"worst":"2", "details":{"1":["Comp1"], "2":["Comp2"]}}, "counts": {A: 0, B: 15, C: 15, D: 8}, "changes":["CHG1234"] },
			{ "from":1533091500, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 0, B: 12, C: 15, D: 8}, "changes":["CHG1234", "CHG2345"] },
			{ "from":1533092400, "severity": {"worst":"0", "details":{}}, "counts": {A: 0, B: 14, C: 15, D: 8}, "changes":[] },
			{ "from":1533093300, "severity": {"worst":"0", "details":{}}, "counts": {A: 0, B: 12, C: 15, D: 8}, "changes":[] },
			{ "from":1533094200, "severity": {"worst":"0", "details":{}}, "counts": {A: 0, B: 6, C: 19, D: 8}, "changes":[] },
			{ "from":1533095100, "severity": {"worst":"0", "details":{}}, "counts": {A: 0, B: 10, C: 23, D: 8}, "changes":[] },
			{ "from":1533096000, "severity": {"worst":"3", "details":{"1":["Comp1"], "2":["Comp2", "Comp8"], "3":["Comp15"]}}, "counts": {A: 0, B: 10, C: 17, D: 8}, "changes":["CHG1234"] },
			{ "from":1533096900, "severity": {"worst":"2", "details":{"1":["Comp1"], "2":["Comp2"]}}, "counts": {A: 0, B: 10, C: 11, D: 8}, "changes":["CHG1234", "CHG2345"] },
			{ "from":1533097800, "severity": {"worst":"1", "details":{"1":["Comp1", "Comp2"]}}, "counts": {A: 0, B: 10, C: 15, D: 8}, "changes":["CHG1234"] },
			{ "from":1533098700, "severity": {"worst":"0", "details":{}}, "counts": {A: 0, B: 10, C: 15, D: 8}, "changes":[] },
		]
		cae.render(dataset);
	
		function getRandomInt(max) {
			return Math.floor(Math.random() * Math.floor(max));
		}

		document.getElementById("refresh").addEventListener("click", function(event){
			dataset.shift();
			var new_item = {
					"from":(dataset[dataset.length-1].from + 15*60),
					"severity": {"worst":getRandomInt(4).toString(), "details":{}},
					"counts": {A: getRandomInt(10)*2, B: getRandomInt(10)*2, C: getRandomInt(10)*3, D: getRandomInt(10)},
					"changes":[]
					};
			switch(new_item.severity.worst){
				case "1":	
					new_item.severity.details = {"1":["Comp1", "Comp2"]};
					break;
				case "2":	
					new_item.severity.details = {"1":["Comp1"], "2":["Comp2"]};
					break;
				case "3":	
					new_item.severity.details = {"1":["Comp1"], "2":["Comp2", "Comp8"], "3":["Comp15"]};
					break;
				default:
					new_item.severity.details = {}
					break;
			};
			for(var i=0; i<getRandomInt(5); i++){
				new_item.changes.push("CHG" + getRandomInt(9999));
			}
			//console.log(new_item);
			dataset.push(new_item);

			cae.render(dataset);
		});
        </script>
    </body>
</html>
